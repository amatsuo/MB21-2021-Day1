---
title: "Tidyverse Exercise"
author: ""
date: "01/08/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Tidyverse

- Load packages
  - we need tidyverse

```{r}
library(tidyverse)
library(stringi)
```

## Section 1: Data description

### read csv data

We will use the country level vaccination in the US. This is public data published by CDC available from: https://data.cdc.gov/Vaccinations/COVID-19-Vaccinations-in-the-United-States-County/8xkx-amqh

You can check the variable definition from the webpage. 

The data is here: https://www.dropbox.com/s/5jy18d1thntcc5t/COVID-19_Vaccinations_in_the_United_States_County.csv.tar.gz?dl=true

#### Download the file

```{r}

dir.create(file.path('data'))

cov_data <- download.file("https://www.dropbox.com/s/5jy18d1thntcc5t/COVID-19_Vaccinations_in_the_United_States_County.csv.tar.gz?dl=true", destfile = "data/covid19_data.csv.tar.gz")

## don't forget to add large file to gitignore..

```

#### Read the file

```{r}
library(data.table)
cov_data <- fread("data/covid19_data.csv.tar.gz")

```


### Simple discription of the table

Now the data is in R workspace. Do the following

### Count the number of variabes and rows

```{r}
nrow(cov_data)
ncol(cov_data)

```

### Print out the first 6 rows of the data.frame

```{r}
head(cov_data)

```


### How many states exists?

(Hint: use `count()`)

- Obviously there are data points not from states. What are they?

```{r}
library(tidyverse)

names(cov_data)

# inspect fips code - first 2 numbers indicate states
cov_data$FIPS %>% str_sub(1,2) %>% factor() %>% levels()
# "UNK" = unkonwn

# count observarions with unknown state
cov_data %>% count(FIPS == "UNK")


# Check recipient state variable
s <- cov_data$Recip_State %>% factor() %>% levels() 
s <- s[!s %in% state.abb]

# states not in built-in state.abb of R:
# Washington DC
# Guam	GU
# Puerto Rico	PR
# Virgin Islands VI




```


## Data wrangling, Part 1

### Convert Date to Date

The variable Date is character. Convert it to a Date variable.

```{r}
library(lubridate)
library(magrittr)
cov_data$Date %>% typeof()
cov_data$Date %>% head()
cov_data$Date %<>% as.Date(format = "%m/%d/%y")
cov_data$Date %>% class()

```

### Erase unnecessary rows

First remove the non-country entries

```{r}

cov_data %<>% filter(!FIPS == "UNK") 


```


### Create a subset dataset

Find the latest date of the data, then subset the data with only the newest date for each country

```{r}
cov_data$Date %>% max()

dates_df <- cov_data %>% 
                group_by(Recip_State) %>%
                summarise(latest = max(Date))

cov_data <- left_join(cov_data, dates_df)

subset_df <- cov_data %>% 
  group_by(Recip_State) %>% 
  filter(Date == latest)

```

### Max percentatge, min percentage

Which county has the highest vaccination rate? What is the number?

```{r}
names(subset_df)

cov_data %>%
  group_by(Recip_State) %>%
  summarize(vacc_rate = max(Completeness_pct)) %>% 
  arrange(desc(vacc_rate)) %>% 
  slice(1)
# Virgin Islands, 100 pct
```


## Data wrangling, Part 2

### Proportion of county with more than 50 percent vaccination rate (latest)

Using the latest data created above, find out proportion of counties with more than 50 percent of vaccine take up rate.

```{r}

vacc_df <- subset_df %>%
              group_by(Recip_County) %>% 
              summarise(vacc_takeup = max(Administered_Dose1_Pop_Pct)) 
vacc_df %>% filter(vacc_takeup > .5) %>% nrow() / nrow(vacc_df)
              
# .97 pct

```

### Proportion of county with more than 50 percent vaccination rate, by state (latest)

```{r}
subset_df %>% group_by(Recip_State) %>% 
                summarise(n = n(),
                v_over50 = sum(as.numeric(Administered_Dose1_Pop_Pct > .5)),
                share = v_over50/n) %>% 
                arrange(desc(share))  %>% head(15)  

# 62 pct Florida


```

### Date when the vaccination rate exceeded 10 percent in each county

```{r}

date_over10_cty <- cov_data %>% filter(Administered_Dose1_Pop_Pct > .1) %>% group_by(Recip_County) %>% summarise(over10_date = min(Date))
summary(date_over10_cty$over10_date)

```

### Aggregate the number of vaccination

For each state, calculate the total number of fully vaccinated people 
and average of vaccination pct across counties for each day (Hint: grouping and summarize)


```{r}
names(cov_data)
cov_data %>% group_by(Recip_State, Date) %>% summarise(fully_vacc_abs = sum(Series_Complete_Yes),
                                                       avg_vacc_rate = mean(Completeness_pct))

```



## Visualizing (Optional)

Now let's visualize the outputs using ggplot

### Time series plot of total vaccination in the US

```{r}

vaccs_p_week <- cov_data %>% group_by(MMWR_week) %>% summarise(sum =sum(Administered_Dose1_Recip, na.rm = T))


ggplot(vaccs_p_week, aes(MMWR_week, sum))+
  geom_bar(stat="identity", na.rm = TRUE)

```


### Time series plot of total vaccination by the state

```{r}
vaccs_p_week_p_state <- cov_data %>% group_by(MMWR_week, Recip_State) %>% summarise(sum =sum(Administered_Dose1_Recip, na.rm = T))

vaccs_p_week_p_state$Recip_State %<>% factor()

ggplot(vaccs_p_week_p_state, aes(MMWR_week, sum, color = Recip_State))+
  geom_line()

## caution: only first shots

```

